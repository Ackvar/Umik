<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üîä Real-Time Spectrum (FFT)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f172a; --panel:#111827; --panel-2:#0b1220;
      --text:#e5e7eb; --muted:#9ca3af; --border:rgba(255,255,255,.06);
      --accent:#22d3ee; --blue:#3b82f6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(34,211,238,.08), transparent),
        radial-gradient(900px 500px at 120% 10%, rgba(99,102,241,.08), transparent),
        var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial;
    }
    .container{max-width:1200px;margin:24px auto 56px;padding:0 16px}
    .page-title{display:flex;align-items:center;gap:12px;font-weight:800;letter-spacing:.2px;font-size:clamp(22px,2.6vw,32px);margin:8px 0 6px}
    .subtitle{color:var(--muted);font-size:14px;margin:0 0 16px}
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{color:var(--text);text-decoration:none;font-size:14px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03)}
    .tab.active{outline:2px solid rgba(34,211,238,.35)}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.03)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    .btn{
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);
      background:rgba(255,255,255,.04);color:var(--text);font-size:13px;cursor:pointer;
    }
    .btn:hover{outline:2px solid rgba(34,211,238,.25)}
    .switch{display:inline-flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .switch input{accent-color:#22d3ee;width:18px;height:18px}
    .live{display:inline-flex;align-items:center;gap:8px;font-size:12px;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%;background:#ef4444;box-shadow:0 0 10px #ef4444}
    .dot.paused{background:#6b7280;box-shadow:none}
    .canvas-wrap{width:100%;height:520px}
    canvas{width:100% !important;height:100% !important;background:#0b0f1a;border:1px solid var(--border);border-radius:14px;padding:8px}
    .status{margin-top:10px;font-size:12px;color:var(--muted)}
    .status-ok{color:#34d399}.status-bad{color:#f87171}
  </style>
</head>
<body>
  <div class="container">
    <div class="page-title">üîâ Real-Time Spectrum (FFT)</div>
    <div class="subtitle">–ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç –æ—Ç 0 –¥–æ 20 –∫–ì—Ü ‚Ä¢ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É ‚Ä¢ —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞ –±–µ–∑ –º–µ—Ä—Ü–∞–Ω–∏—è</div>

    <!-- –í–∫–ª–∞–¥–∫–∏ –∫–∞–∫ –Ω–∞ –¥—Ä—É–≥–∏—Ö —Å—Ç—Ä–∞–Ω–∏—Ü–∞—Ö -->
    <nav class="tabs">
      <a class="tab" href="/table">–¢–∞–±–ª–∏—Ü–∞</a>
      <a class="tab" href="/chart">–ì—Ä–∞—Ñ–∏–∫ SPL</a>
      <a class="tab" href="/octave">–û–∫—Ç–∞–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑</a>
      <a class="tab active" href="/rta">RTA</a>
      <a class="tab" href="/filtr">–§–∏–ª—å—Ç—Ä—ã</a>
    </nav>

    <div class="card">
      <div class="controls">
        <button id="btnPause" class="btn">‚è∏ –ü–∞—É–∑–∞</button>
        <label class="switch"><input id="chkAutoY" type="checkbox" checked>–ê–≤—Ç–æ-–º–∞—Å—à—Ç–∞–± Y</label>
        <label class="switch"><input id="chkSmoothing" type="checkbox" checked>–°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –ª–∏–Ω–∏–∏</label>
        <div class="live"><span id="liveDot" class="dot"></span><span id="liveText">LIVE</span></div>
      </div>

      <div class="canvas-wrap">
        <canvas id="fftChart"></canvas>
      </div>

      <div id="status" class="status">–°—Ç–∞—Ç—É—Å: –æ–∂–∏–¥–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶</div>
    </div>
  </div>

  <script>
    const ctx = document.getElementById('fftChart').getContext('2d');

    // –õ–∏–Ω–∏—è-–≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ø—Ä–∏—è—Ç–Ω–æ–≥–æ –≤–∏–¥–∞
    const gradBlue = ctx.createLinearGradient(0,0,0,400);
    gradBlue.addColorStop(0,'rgba(59,130,246,.35)');
    gradBlue.addColorStop(1,'rgba(59,130,246,.08)');

    const chart = new Chart(ctx, {
      type: 'line',
      data: { labels: [], datasets: [{
        label: 'FFT (–∞–º–ø–ª–∏—Ç—É–¥–∞)',
        data: [],
        borderColor: '#3b82f6',
        backgroundColor: gradBlue,
        pointRadius: 0,
        borderWidth: 1,
        tension: .25,
        fill: true
      }]},
      options: {
        animation: false,
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: {
            display: true,
            text: '–ê–Ω–∞–ª–∏–∑ —á–∞—Å—Ç–æ—Ç –æ—Ç 0 –¥–æ 20 –∫–ì—Ü (1 —Å–µ–∫—É–Ω–¥–∞)',
            color: '#e5e7eb', font: { weight:'700', size:16 }, padding:{ top:4,bottom:10 }
          },
          tooltip: {
            backgroundColor: 'rgba(17,24,39,.96)',
            borderColor: 'rgba(255,255,255,.08)',
            borderWidth: 1,
            titleColor: '#e5e7eb',
            bodyColor: '#e5e7eb',
            callbacks: {
              label: (c)=>`–ê–º–ø: ${Number(c.parsed.y).toFixed(1)}`,
              title: (items)=>`–ß–∞—Å—Ç–æ—Ç–∞: ${Number(items[0].label).toFixed(0)} –ì—Ü`
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            min: 0, max: 20000,
            ticks: { color:'rgba(229,231,235,.9)' },
            grid: { color:'rgba(255,255,255,.06)' },
            title: { display:true, text:'–ß–∞—Å—Ç–æ—Ç–∞ (–ì—Ü)', color:'#e5e7eb', padding:6 }
          },
          y: {
            ticks: { color:'rgba(229,231,235,.9)' },
            grid: { color:'rgba(255,255,255,.06)' },
            title: { display:true, text:'–ê–º–ø–ª–∏—Ç—É–¥–∞ (–Ω–æ—Ä–º.)', color:'#e5e7eb', padding:6 }
          }
        }
      }
    });

    // --- –†–µ–∞–ª-—Ç–∞–π–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –º–∏–≥–∞–Ω–∏—è ---
    const statusEl = document.getElementById('status');
    const btnPause = document.getElementById('btnPause');
    const chkAutoY = document.getElementById('chkAutoY');
    const chkSmoothing = document.getElementById('chkSmoothing');
    const liveDot = document.getElementById('liveDot');

    let paused = false;
    let currentController = null; // AbortController –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

    btnPause.addEventListener('click', ()=>{
      paused = !paused;
      btnPause.textContent = paused ? '‚ñ∂Ô∏è –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞';
      liveDot.classList.toggle('paused', paused);
    });

    chkSmoothing.addEventListener('change', ()=>{
      chart.data.datasets[0].tension = chkSmoothing.checked ? .25 : 0;
      chart.update('none');
    });

    function applyAutoY(values){
      if(!chkAutoY.checked) return;
      let min = Infinity, max = -Infinity;
      for(const v of values){ if(v<min) min=v; if(v>max) max=v; }
      if(!isFinite(min) || !isFinite(max)) return;
      if(min===max){ max = min + 1; min = Math.max(0, min - 1); }
      chart.options.scales.y.min = Math.floor(min);
      chart.options.scales.y.max = Math.ceil(max);
    }

    async function fetchFFT(){
      if(paused) return;

      // –æ—Ç–º–µ–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è
      try{ currentController?.abort(); }catch(_){}
      currentController = new AbortController();

      try{
        statusEl.textContent = '–°—Ç–∞—Ç—É—Å: –ø–æ–ª—É—á–∞—é –¥–∞–Ω–Ω—ã–µ‚Ä¶';
        const res = await fetch('/api/fft', { cache:'no-store', signal: currentController.signal });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json();

        const freqs = data.freqs || [];
        const vals  = data.values || [];

        // –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
        chart.data.labels = freqs;
        chart.data.datasets[0].data = freqs.map((f,i)=>({x:f, y:vals[i] ?? 0}));

        applyAutoY(vals);
        chart.update('none');

        statusEl.innerHTML = '–°—Ç–∞—Ç—É—Å: <span class="status-ok">–æ–±–Ω–æ–≤–ª–µ–Ω–æ</span>';
      }catch(e){
        if(e.name === 'AbortError') return; // –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è –æ—Ç–º–µ–Ω–∞
        console.error(e);
        statusEl.innerHTML = '–°—Ç–∞—Ç—É—Å: <span class="status-bad">–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>';
      }
    }

    // –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –∏ —Ç–∞–π–º–µ—Ä ¬´–ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—è¬ª
    fetchFFT();
    setInterval(fetchFFT, 1000);
  </script>
</body>
</html>
